<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>食材庫存追蹤器</title>
    <!-- 載入 Tailwind CSS CDN (用於快速樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // 設定 Tailwind CSS 配置
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // 加入中文字體 Noto Sans TC
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4F46E5', // Indigo-600 (主要色：按鈕、邊框)
                        'secondary': '#10B981', // Emerald-500 (次要色：成功、突出)
                    }
                }
            }
        }
    </script>
    <!-- 自定義樣式 -->
    <style>
        /* 確保 input[type=number] 不顯示上下箭頭 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans">

    <div class="max-w-6xl mx-auto pb-20"> 
        <!-- 標題與協作資訊 -->
        <header class="mb-8 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-primary mb-2 tracking-tight">食材新鮮度追蹤</h1>
            <div class="flex flex-wrap items-center text-sm text-gray-500">
                <p class="mr-4">狀態: <span id="auth-status" class="font-semibold text-orange-500">離線模式 (Local Storage)</span></p>
                <!-- 顯示 Local Storage 狀態 -->
                <p class="truncate">您的 ID: <code id="user-id-display" class="font-mono text-gray-700 bg-gray-100 p-1 rounded">Local Browser Storage</code></p>
            </div>
        </header>

        <!-- 輸入表單 1: 生鮮食材 -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">生鮮食材 (預估保鮮期)</h2>
            <form id="fresh-ingredient-form" class="grid grid-cols-1 gap-4 md:grid-cols-6">
                <div class="md:col-span-1">
                    <label for="fresh-name" class="block text-sm font-medium text-gray-700 mb-1">食材名稱</label>
                    <input type="text" id="fresh-name" name="name" required class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150" placeholder="例如：雞胸肉">
                </div>
                <div class="md:col-span-1">
                    <label for="fresh-quantity" class="block text-sm font-medium text-gray-700 mb-1">數量/單位</label>
                    <input type="text" id="fresh-quantity" name="quantity" required class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150" value="1 公斤">
                </div>
                <div class="md:col-span-1">
                    <label for="fresh-location" class="block text-sm font-medium text-gray-700 mb-1">儲存位置</label>
                    <select id="fresh-location" name="location" required class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                        <option value="refrigerated">冷藏</option>
                        <option value="frozen">冷凍</option>
                        <option value="room">常溫</option>
                    </select>
                </div>
                <div class="md:col-span-1">
                    <label for="fresh-inventoryDate" class="block text-sm font-medium text-gray-700 mb-1">納入庫存日期</label>
                    <input type="date" id="fresh-inventoryDate" name="inventoryDate" required class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>
                <div class="md:col-span-1">
                    <label for="fresh-storageDays" class="block text-sm font-medium text-gray-700 mb-1">預計可存放時間 (日)</label>
                    <input type="number" id="fresh-storageDays" name="storageDays" required min="1" value="7" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>
                <div class="md:col-span-1 flex items-end">
                    <button type="submit" form="fresh-ingredient-form" class="w-full bg-secondary text-white font-bold py-2.5 px-4 rounded-lg hover:bg-emerald-600 transition duration-150 shadow-md hover:shadow-lg">
                        加入清單
                    </button>
                </div>
            </form>
        </div>

        <!-- 輸入表單 2: 包裝食材 -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">包裝食材 (指定有效期限)</h2>
            <form id="packaged-ingredient-form" class="grid grid-cols-1 gap-4 md:grid-cols-6">
                <div class="md:col-span-1">
                    <label for="pkg-name" class="block text-sm font-medium text-gray-700 mb-1">食材名稱</label>
                    <input type="text" id="pkg-name" name="name" required class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150" placeholder="例如：義大利麵醬">
                </div>
                <div class="md:col-span-1">
                    <label for="pkg-quantity" class="block text-sm font-medium text-gray-700 mb-1">數量/單位</label>
                    <input type="text" id="pkg-quantity" name="quantity" required class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150" value="1 罐">
                </div>
                <div class="md:col-span-1">
                    <label for="pkg-location" class="block text-sm font-medium text-gray-700 mb-1">儲存位置</label>
                    <select id="pkg-location" name="location" required class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                        <option value="room">常溫</option>
                        <option value="refrigerated">冷藏</option>
                        <option value="frozen">冷凍</option>
                    </select>
                </div>
                <div class="md:col-span-1">
                    <label for="pkg-inventoryDate" class="block text-sm font-medium text-gray-700 mb-1">納入庫存日期</label>
                    <input type="date" id="pkg-inventoryDate" name="inventoryDate" required class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>
                <div class="md:col-span-1">
                    <label for="pkg-expiryDateInput" class="block text-sm font-medium text-gray-700 mb-1">有效期限</label>
                    <input type="date" id="pkg-expiryDateInput" name="expiryDateInput" required class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>
                <div class="md:col-span-1 flex items-end">
                    <button type="submit" form="packaged-ingredient-form" class="w-full bg-secondary text-white font-bold py-2.5 px-4 rounded-lg hover:bg-emerald-600 transition duration-150 shadow-md hover:shadow-lg">
                        加入清單
                    </button>
                </div>
            </form>
        </div>

        <!-- 食材清單顯示區 -->
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold text-gray-800">所有食材清單</h2>
            <button id="toggle-used-visibility" class="text-sm font-medium text-primary hover:text-indigo-700 transition duration-150 p-2 rounded-lg bg-indigo-50/50">
                顯示已使用的項目
            </button>
        </div>
        
        <div id="ingredient-list" class="grid grid-cols-1 gap-4">
            <p id="empty-state" class="text-center text-gray-500 py-8 italic hidden">目前沒有任何食材。請新增！</p>
            <p id="loading-state" class="text-center text-gray-500 py-8 italic font-semibold animate-pulse">正在載入本地庫存資料...</p>
        </div>

    </div>
    
    <!-- 自定義刪除確認 Modal (取代 window.confirm) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold text-red-600 mb-3">確認刪除</h3>
            <p class="text-gray-700 mb-6" id="modal-message">您確定要永久刪除此項目嗎？此操作不可逆！</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150 shadow-md">取消</button>
                <button id="modal-delete-btn" class="px-4 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600 transition duration-150 shadow-md">永久刪除</button>
            </div>
        </div>
    </div>

    <!-- 腳本區塊 (已移除 type="module" 以避免 Firebase 錯誤) -->
    <script>
        // --- DOM 元素引用 ---
        const freshForm = document.getElementById('fresh-ingredient-form');
        const packagedForm = document.getElementById('packaged-ingredient-form');
        const listContainer = document.getElementById('ingredient-list');
        const emptyState = document.getElementById('empty-state');
        const loadingState = document.getElementById('loading-state');
        const toggleButton = document.getElementById('toggle-used-visibility');
        const modal = document.getElementById('confirmation-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalDeleteBtn = document.getElementById('modal-delete-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        // --- 應用程式狀態 ---
        let ingredientsData = []; 
        let showUsedItems = false; 
        let pendingDeleteId = null; 
        const LOCAL_STORAGE_KEY = 'foodTrackerData';

        // --- Local Storage 數據處理 ---

        /**
         * 從瀏覽器的 Local Storage 載入數據
         */
        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                ingredientsData = data ? JSON.parse(data) : [];
            } catch (error) {
                console.error("Error loading data from Local Storage:", error);
                ingredientsData = []; 
            }
        }

        /**
         * 將當前數據保存到瀏覽器的 Local Storage
         */
        function saveToLocalStorage() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(ingredientsData));
                renderIngredients(); // 保存後重新渲染清單
            } catch (error) {
                console.error("Error saving data to Local Storage:", error);
            }
        }
        
        // --- 工具函數 ---

        /**
         * 根據到期日計算狀態
         */
        function getExpiryStatus(expiryDateString) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const expiryDate = new Date(expiryDateString);
            expiryDate.setHours(0, 0, 0, 0);

            const diffTime = expiryDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let color = 'bg-secondary text-white'; 
            let warningText = `剩餘 ${diffDays} 天`;
            let ringColor = 'ring-secondary';

            if (diffDays < 0) {
                color = 'bg-red-600 text-white';
                warningText = `已過期 ${Math.abs(diffDays)} 天`;
                ringColor = 'ring-red-600';
            } else if (diffDays <= 3) {
                color = 'bg-orange-500 text-white';
                warningText = `即將過期 (剩 ${diffDays} 天)`;
                ringColor = 'ring-orange-500';
            } else if (diffDays <= 7) {
                 color = 'bg-yellow-500 text-gray-800';
                 warningText = `剩餘 ${diffDays} 天`;
                 ringColor = 'ring-yellow-500';
            } else {
                 color = 'bg-secondary text-white';
            }

            return { days: diffDays, color, warningText, ringColor };
        }
        
        /**
         * 將儲存位置的 key 轉換為中文名稱
         */
        function getLocationDisplayName(key) {
            switch (key) {
                case 'refrigerated': return '冷藏';
                case 'frozen': return '冷凍';
                case 'room': return '常溫';
                default: return '常溫';
            }
        }
        
        /**
         * 獲取位置的排序優先級
         */
        function getLocationPriority(locationKey) {
            switch (locationKey) {
                case 'refrigerated': return 1; 
                case 'room': return 2;       
                case 'frozen': return 3;     
                default: return 4; 
            }
        }

        // --- 渲染邏輯 ---
        function renderIngredients() {
            const displayIngredients = [...ingredientsData]
                .filter(item => showUsedItems || !item.isUsed); 

            // 排序: 1. 按儲存位置優先級, 2. 按到期日 (越近越前)
            displayIngredients.sort((a, b) => {
                const priorityA = getLocationPriority(a.location || 'room');
                const priorityB = getLocationPriority(b.location || 'room');
                
                if (priorityA !== priorityB) {
                    return priorityA - priorityB;
                }
                
                const dateA = new Date(a.expiryDate);
                const dateB = new Date(b.expiryDate);
                return dateA - dateB;
            });

            listContainer.innerHTML = '';
            loadingState.classList.add('hidden'); 

            if (displayIngredients.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            displayIngredients.forEach(item => {
                const status = getExpiryStatus(item.expiryDate);
                const locationDisplay = getLocationDisplayName(item.location || 'room'); 
                
                const isItemUsed = item.isUsed;
                
                // 根據狀態和使用情況設定卡片樣式
                let cardClasses = 'flex flex-col md:flex-row md:items-center md:justify-between p-4 rounded-xl shadow-lg transition duration-200 w-full cursor-pointer';
                let actionText = isItemUsed ? '重新上架' : '標記為已使用';
                let actionColor = isItemUsed ? 'bg-primary hover:bg-indigo-700' : 'bg-gray-400 hover:bg-gray-500';

                if (isItemUsed) {
                    cardClasses += ' bg-gray-100 opacity-60';
                } else if (status.days < 0) {
                    cardClasses += ' bg-red-50 ring-2 ring-red-300'; 
                } else if (status.days <= 3) {
                    cardClasses += ' bg-orange-50 ring-2 ring-orange-300'; 
                } else {
                    cardClasses += ' bg-white hover:shadow-xl';
                }
                
                const quantityDisplayHtml = `
                    <div class="flex items-center text-sm text-gray-600 mt-1">
                        <span class="mr-2">數量:</span>
                        <!-- 數量輸入框，綁定 Local Storage 更新 -->
                        <input type="text" 
                            value="${item.quantity}" 
                            data-id="${item.id}"
                            data-listener="quantity-input"
                            class="quantity-input w-28 px-2 py-0.5 border border-gray-300 rounded text-center font-semibold focus:border-primary focus:ring-1 focus:ring-primary ${isItemUsed ? 'bg-gray-200 cursor-not-allowed' : 'bg-white'}"
                            ${isItemUsed ? 'disabled' : ''}>
                    </div>
                `;

                const cardHtml = `
                    <div class="${cardClasses}" data-id="${item.id}">
                        <!-- 左側：名稱、位置與數量 -->
                        <div class="w-full md:w-1/3 md:flex-grow mr-0 md:mr-4 mb-3 md:mb-0">
                            <p class="text-xl font-bold truncate ${isItemUsed ? 'line-through text-gray-500' : 'text-gray-800'}">${item.name}</p>
                            <p class="text-xs font-medium text-primary/80 mb-1">位置: ${locationDisplay} | 入庫: ${item.inventoryDate}</p>
                            ${quantityDisplayHtml}
                        </div>
                        
                        <!-- 中央：過期資訊 -->
                        <div class="w-full md:w-auto md:flex-shrink-0 pt-3 md:pt-0 mt-3 md:mt-0 md:mx-4 min-w-[200px] text-left md:text-right border-t border-gray-100 md:border-t-0">
                            <p class="text-sm font-semibold text-gray-500">預計可存放: ${item.storageDays} 日</p>
                            <p class="text-lg font-bold text-gray-800 mb-1">到期日: ${item.expiryDate}</p>
                            <!-- 過期提醒標籤 -->
                            <span class="inline-block px-3 py-1 text-sm font-bold rounded-full ${status.color} ring-1 ${status.ringColor}">
                                ${status.warningText}
                            </span>
                        </div>

                        <!-- 右側：管理按鈕 -->
                        <div class="w-full flex justify-end md:w-auto md:justify-start mt-4 md:mt-0 flex-shrink-0 space-x-2">
                            <!-- 標記為使用/未使用 切換按鈕 -->
                            <button data-action="toggle-used" data-id="${item.id}"
                                class="p-3 rounded-full text-white transition duration-150 shadow-md text-sm font-semibold ${actionColor}"
                                title="${actionText}">
                                <!-- Lucide Icon: Check/Refresh -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    ${isItemUsed ? 
                                        '<path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 16"/> <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/> <path d="M3 21v-5h5"/>' : 
                                        '<path d="M20 6 9 17l-5-5"/>'
                                    }
                                </svg>
                            </button>

                            <!-- 刪除按鈕 -->
                            <button data-action="delete" data-id="${item.id}"
                                class="p-3 rounded-full bg-red-500 text-white hover:bg-red-600 transition duration-150 shadow-md"
                                title="永久刪除此項目">
                                <!-- Lucide Icon: Trash -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        // --- Local Mode 數據操作函數 ---

        /**
         * 處理表單提交並將資料儲存到 Local Storage
         */
        function saveNewIngredientLocal(ingredientData, formId, inventoryDateId) {
            const newIngredient = {
                ...ingredientData,
                id: Date.now().toString(), // 賦予一個唯一的ID
                isUsed: false,
            };

            ingredientsData.push(newIngredient);
            saveToLocalStorage(); // 保存到 Local Storage

            // 重設表單
            document.getElementById(formId).reset();
            setInitialDates(); // 重新設定今日日期
        }
        
        /**
         * 處理數量欄位失焦 (onblur) 進行更新
         */
        function handleQuantityChange(inputElement) {
            const id = inputElement.dataset.id;
            const newQuantity = inputElement.value.trim();

            if (!id || !newQuantity) {
                renderIngredients(); // Revert if data is bad
                return;
            }

            const itemIndex = ingredientsData.findIndex(item => item.id === id);
            if (itemIndex > -1) {
                ingredientsData[itemIndex].quantity = newQuantity;
                saveToLocalStorage();
            }
        }
        
        /**
         * 切換項目的使用狀態
         */
        function toggleUsedStatusLocal(id) {
            const itemIndex = ingredientsData.findIndex(item => item.id === id);
            if (itemIndex > -1) {
                ingredientsData[itemIndex].isUsed = !ingredientsData[itemIndex].isUsed;
                saveToLocalStorage();
            }
        }
        
        /**
         * 刪除指定項目
         */
        function deleteIngredientLocal(id) {
            ingredientsData = ingredientsData.filter(item => item.id !== id);
            saveToLocalStorage();
        }

        // --- 彈窗邏輯 ---
        function showConfirmModal(id, name) {
            pendingDeleteId = id;
            modalMessage.textContent = `您確定要永久刪除食材「${name}」嗎？此操作不可逆！`;
            modal.classList.remove('hidden');
        }
        
        function hideConfirmModal() {
            modal.classList.add('hidden');
            pendingDeleteId = null;
        }
        
        function deleteConfirmed() {
            if (!pendingDeleteId) {
                hideConfirmModal();
                return;
            }
            
            const id = pendingDeleteId;
            hideConfirmModal();
            deleteIngredientLocal(id);
        }
        
        // 綁定 Modal 按鈕事件
        modalCancelBtn.addEventListener('click', hideConfirmModal);
        modalDeleteBtn.addEventListener('click', deleteConfirmed);

        // --- 初始化函數 ---

        /**
         * 設定日期輸入框的初始值和限制
         */
        function setInitialDates() {
             const today = new Date().toISOString().split('T')[0];
            
            // 設定今日日期為預設值並限制最大日期 (入庫日期不能超過今天)
            document.getElementById('fresh-inventoryDate').value = today;
            document.getElementById('fresh-inventoryDate').setAttribute('max', today); 
            document.getElementById('pkg-inventoryDate').value = today;
            document.getElementById('pkg-inventoryDate').setAttribute('max', today);

            // 包裝食材有效期限不能早於今天
            document.getElementById('pkg-expiryDateInput').setAttribute('min', today);
        }

        /**
         * 應用程式啟動主函數
         */
        function initApp() {
            setInitialDates(); // 1. 設定日期輸入框
            loadFromLocalStorage(); // 2. 載入數據
            renderIngredients(); // 3. 渲染清單
        }

        // --- 事件監聽器 (Forms & Actions) ---

        // 處理生鮮食材表單提交
        freshForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = document.getElementById('fresh-name').value.trim();
            const quantity = document.getElementById('fresh-quantity').value.trim();
            const location = document.getElementById('fresh-location').value;
            const inventoryDate = document.getElementById('fresh-inventoryDate').value;
            const storageDays = parseInt(document.getElementById('fresh-storageDays').value);

            if (!name || !quantity || isNaN(storageDays) || storageDays < 1) return;

            // 計算預計到期日
            const invDate = new Date(inventoryDate);
            invDate.setDate(invDate.getDate() + storageDays);
            const expiryDate = invDate.toISOString().split('T')[0]; // YYYY-MM-DD

            const data = { name, quantity, location, inventoryDate, storageDays, expiryDate };
            saveNewIngredientLocal(data, 'fresh-ingredient-form', 'fresh-inventoryDate');
        });

        // 處理包裝食材表單提交
        packagedForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = document.getElementById('pkg-name').value.trim();
            const quantity = document.getElementById('pkg-quantity').value.trim();
            const location = document.getElementById('pkg-location').value;
            const inventoryDate = document.getElementById('pkg-inventoryDate').value;
            const expiryDate = document.getElementById('pkg-expiryDateInput').value;

            if (!name || !quantity || !expiryDate || !inventoryDate) return;

            // 計算可存放天數 (用於顯示)
            const invDate = new Date(inventoryDate);
            const expDate = new Date(expiryDate);
            const diffTime = expDate.getTime() - invDate.getTime();
            const storageDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            const data = { name, quantity, location, inventoryDate, storageDays, expiryDate };
            saveNewIngredientLocal(data, 'packaged-ingredient-form', 'pkg-inventoryDate');
        });
        
        // 處理顯示/隱藏已使用項目按鈕
        toggleButton.addEventListener('click', () => {
            showUsedItems = !showUsedItems;
            toggleButton.textContent = showUsedItems ? '隱藏已使用的項目' : '顯示已使用的項目';
            
            if (showUsedItems) {
                toggleButton.classList.add('bg-primary/10', 'text-primary');
            } else {
                toggleButton.classList.remove('bg-primary/10', 'text-primary');
            }
            renderIngredients();
        });

        // 動態元素事件監聽 (數量輸入框失焦時更新)
        listContainer.addEventListener('blur', (e) => {
            const input = e.target.closest('.quantity-input');
            // 檢查是否為數量輸入框且未被禁用
            if (input && input.dataset.listener === 'quantity-input' && !input.disabled) {
                handleQuantityChange(input);
            }
        }, true); 

        // 卡片按鈕點擊事件 (Toggle used/Delete)
        listContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return; 

            const action = button.dataset.action;
            const id = button.dataset.id;
            const item = ingredientsData.find(i => i.id === id);

            if (!id || !item) return;

            switch (action) {
                case 'toggle-used':
                    toggleUsedStatusLocal(id);
                    break;
                case 'delete':
                    showConfirmModal(id, item.name);
                    break;
            }
        });

        // --- 應用程式啟動 (使用 DOMContentLoaded 確保 DOM 準備就緒) ---
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
